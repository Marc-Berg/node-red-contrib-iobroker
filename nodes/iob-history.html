<script type="text/javascript">
// Shared TreeView loader
function loadSharedTreeView() {
    return new Promise((resolve, reject) => {
        if (window.ioBrokerSharedTreeView && window.ioBrokerSharedTreeView.initialized) {
            resolve();
            return;
        }
        
        const script = document.createElement('script');
        script.src = 'iobroker/shared/iobroker-treeview.js?v=1.0.0';
        script.async = true;
        
        script.onload = () => {
            if (window.ioBrokerSharedTreeView && window.ioBrokerSharedTreeView.initialized) {
                resolve();
            } else {
                reject(new Error('TreeView component failed to initialize'));
            }
        };
        
        script.onerror = () => reject(new Error('TreeView component script not found'));
        document.head.appendChild(script);
    });
}

RED.nodes.registerType('iobhistory', {
    category: 'ioBroker WS',
    color: '#a6bbcf',
    defaults: {
        name: { value: "" },
        stateId: { value: "" },
        historyAdapter: { value: "history.0" },
        timeRange: { value: "duration" },
        duration: { value: 24 },
        durationUnit: { value: "hours" },
        startTime: { value: "" },
        endTime: { value: "" },
        aggregate: { value: "onchange" },
        step: { value: 300 },
        stepUnit: { value: "seconds" },
        maxEntries: { value: 2000 },
        queryMode: { value: "parallel" },
        outputProperty: { value: "payload" },
        outputFormat: { value: "array" },
        percentile: { value: 50 },
        quantile: { value: 0.5 },
        integralUnit: { value: 3600 },
        removeBorderValues: { value: false },
        timestampFormat: { value: "unix" },
        customTimeFormat: { value: "DD.MM.YYYY HH:mm:ss" },
        timezone: { value: "auto" },
        dataFormat: { value: "full" },
        server: { value: "", type: "iob-config" }
    },
    inputs: 1,
    outputs: 1,
    icon: "iobroker_history.svg",
    paletteLabel: "WS ioB history",
    label: function() {
        if (this.name) return this.name;
        
        const timeInfo = this.timeRange === 'duration' 
            ? `${this.duration}${this.durationUnit.charAt(0)}`
            : this.timeRange === 'absolute' ? 'abs' : 'msg';
            
        return `${this.stateId || 'history'} (${timeInfo}, ${this.aggregate})`;
    },
    
    oneditprepare: function() {
        const node = this;
        const serverInput = $('#node-input-server');
        
        // Tab switching functionality
        function initializeTabs() {
            $('.node-config-tabs li').on('click', function() {
                const tabId = $(this).data('tab');
                
                // Update active tab
                $('.node-config-tabs li').removeClass('active');
                $(this).addClass('active');
                
                // Show corresponding tab content
                $('.tab-content .tab-pane').removeClass('active');
                $(`.tab-content .tab-pane[data-tab="${tabId}"]`).addClass('active');
            });
            
            // Activate first tab by default
            $('.node-config-tabs li:first').addClass('active');
            $('.tab-content .tab-pane:first').addClass('active');
        }
        
        function showDefaultAdapterSuggestions() {
            $('.adapter-list').html('<span style="color: #6c757d; font-style: italic;">Loading available adapters...</span>');
            $('.adapter-suggestions').show();
        }
        
        function loadHistoryAdapters() {
            const serverNode = RED.nodes.node(serverInput.val());
            if (!serverNode) {
                console.log('No server node selected for history adapter discovery');
                return;
            }
            
            const serverId = `${serverNode.iobhost}:${serverNode.iobport}`;
            console.log('Loading history adapters from:', serverId);
            
            $.ajax({
                url: `/iobroker/ws/adapters/${encodeURIComponent(serverId)}`,
                method: 'GET',
                timeout: 15000,
                dataType: 'json',
                cache: false
            }).done((response) => {
                console.log('History adapters response:', response);
                
                if (response.adapters && response.adapters.length > 0) {
                    const adapters = response.adapters;
                    
                    const adapterButtons = adapters.map(adapter => {
                        const statusClass = adapter.alive ? 'alive' : (adapter.enabled ? 'enabled' : 'disabled');
                        const statusIcon = adapter.alive ? 'üü¢' : (adapter.enabled ? 'üü°' : 'üî¥');
                        const title = `${adapter.title || adapter.name} - ${adapter.alive ? 'Running' : adapter.enabled ? 'Enabled but not running' : 'Disabled'}`;
                        
                        return `<a href="#" data-adapter="${adapter.name}" class="${statusClass}" title="${title}">${statusIcon} ${adapter.name}</a>`;
                    }).join('');
                    
                    const fallbacks = ['history.0', 'sql.0', 'influxdb.0'].filter(name => 
                        !adapters.find(a => a.name === name)
                    ).map(name => 
                        `<a href="#" data-adapter="${name}" class="fallback" title="Common adapter (not verified)">${name}</a>`
                    ).join('');
                    
                    $('.adapter-list').html(adapterButtons + fallbacks);
                    
                    $('.adapter-list a').on('click', function(e) {
                        e.preventDefault();
                        const adapter = $(this).data('adapter');
                        $('#node-input-historyAdapter').val(adapter);
                        $(this).addClass('selected').siblings().removeClass('selected');
                        return false;
                    });
                    
                    const currentAdapter = $('#node-input-historyAdapter').val();
                    $(`.adapter-list a[data-adapter="${currentAdapter}"]`).addClass('selected');
                    
                    $('.adapter-suggestions').show();
                    console.log(`Found ${adapters.length} history adapters on ${serverId}`);
                } else {
                    console.log('No history adapters found, keeping default suggestions');
                }
            }).fail((xhr, status, error) => {
                console.error('Failed to load history adapters:', status, error);
                
                const fallbackAdapters = ['history.0', 'sql.0', 'influxdb.0', 'history.1', 'sql.1', 'influxdb.1'];
                $('.adapter-list').html(
                    '<span style="color: #dc3545; margin-right: 10px;">‚ö†Ô∏è Could not load from server</span>' +
                    fallbackAdapters.map(adapter => 
                        `<a href="#" data-adapter="${adapter}" class="fallback" title="Common adapter (not verified)">${adapter}</a>`
                    ).join('')
                );
                
                $('.adapter-list a').on('click', function(e) {
                    e.preventDefault();
                    const adapter = $(this).data('adapter');
                    $('#node-input-historyAdapter').val(adapter);
                    $(this).addClass('selected').siblings().removeClass('selected');
                    return false;
                });
            });
        }
        
        function initializeHistoryAdapterSuggestions() {
            // Show default suggestions immediately
            showDefaultAdapterSuggestions();
            
            // Try to load from server if available
            setTimeout(() => {
                loadHistoryAdapters();
            }, 1000);
            
            // Reload adapters when server changes
            serverInput.on('change', () => {
                console.log('Server changed, reloading history adapters...');
                $('.adapter-suggestions').hide();
                setTimeout(() => {
                    showDefaultAdapterSuggestions();
                    setTimeout(loadHistoryAdapters, 500);
                }, 100);
            });
        }
        
        // Initialize tabs
        initializeTabs();
        
        // Auto-select server configuration
        if (!node.server || node.server === '') {
            const configNodes = [];
            RED.nodes.eachConfig(function(config) {
                if (config.type === 'iob-config') {
                    configNodes.push(config);
                }
            });
            
            if (configNodes.length === 1) {
                node.server = configNodes[0].id;
                serverInput.val(node.server);
                
                setTimeout(() => {
                    RED.notify(`Automatically selected server: ${configNodes[0].name || configNodes[0].iobhost}`, {
                        type: "info",
                        timeout: 1500
                    });
                }, 500);
            }
        }
        
        // Time range mode handlers
        $('input[name="timeRangeMode"]').on('change', function() {
            const mode = $(this).val();
            $('.time-config-section').hide();
            $(`.time-config-section.${mode}`).show();
            $('#node-input-timeRange').val(mode);
        });
        
        // Initialize time range mode
        const currentMode = node.timeRange || 'duration';
        $(`input[name="timeRangeMode"][value="${currentMode}"]`).prop('checked', true);
        $('.time-config-section').hide();
        $(`.time-config-section.${currentMode}`).show();
        
        // Aggregation change handler
        $('#node-input-aggregate').on('change', function() {
            const aggregate = $(this).val();
            const stepConfig = $('#step-config');
            const needsStep = ['average', 'min', 'max', 'total', 'count', 'percentile', 'quantile', 'integral'].includes(aggregate);
            
            if (needsStep) {
                stepConfig.show();
            } else {
                stepConfig.hide();
            }
            
            // Show/hide special options
            $('.aggregate-option').hide();
            if (aggregate === 'percentile') {
                $('#percentile-config').show();
            } else if (aggregate === 'quantile') {
                $('#quantile-config').show();
            } else if (aggregate === 'integral') {
                $('#integral-config').show();
            }
        });
        
        // Initialize aggregation
        $('#node-input-aggregate').trigger('change');
        
        // Output format change handler
        $('#node-input-outputFormat').on('change', function() {
            const format = $(this).val();
            $('.output-format-info').hide();
            $(`.output-format-info.${format}`).show();
        });
        
        // Query mode change handler
        $('#node-input-queryMode').on('change', function() {
            const mode = $(this).val();
            const infoElement = $('#query-mode-info');
            let infoText = '';
            
            switch(mode) {
                case 'parallel':
                    infoText = '<i class="fa fa-info-circle"></i> <strong>Parallel:</strong> Multiple queries can run simultaneously. Fast but may overload the history adapter with many requests.';
                    break;
                case 'sequential':
                    infoText = '<i class="fa fa-clock-o"></i> <strong>Sequential:</strong> Queries are processed one after another in order. Slower but ensures reliable processing of all requests.';
                    break;
                case 'drop':
                    infoText = '<i class="fa fa-filter"></i> <strong>Drop:</strong> New queries are discarded while one is running. Best for UI updates where only the latest result matters.';
                    break;
            }
            
            infoElement.html(infoText);
        });
        
        // Data format change handler
        $('#node-input-dataFormat').on('change', function() {
            const format = $(this).val();
            const infoElement = $('#data-format-info');
            let infoText = '';
            
            switch(format) {
                case 'full':
                    infoText = '<i class="fa fa-info-circle"></i> <strong>Full Format:</strong> Complete data objects including ts, val, ack, from, q, lc and other metadata.';
                    break;
                case 'simple':
                    infoText = '<i class="fa fa-compress"></i> <strong>Simple Format:</strong> Only timestamp (ts) and value (val) properties. Smaller payload, faster processing.';
                    break;
            }
            
            infoElement.html(infoText);
        });
        
        // Timestamp format change handler
        $('#node-input-timestampFormat').on('change', function() {
            const format = $(this).val();
            const infoElement = $('#timestamp-format-info');
            const customConfig = $('#custom-format-config');
            let infoText = '';
            
            switch(format) {
                case 'unix':
                    infoText = '<i class="fa fa-clock-o"></i> <strong>Unix Timestamp:</strong> Milliseconds since epoch (e.g., 1609459200000). Standard for JavaScript Date objects.';
                    customConfig.hide();
                    break;
                case 'iso':
                    infoText = '<i class="fa fa-calendar"></i> <strong>ISO 8601 String:</strong> UTC format (e.g., "2021-01-01T00:00:00.000Z"). International standard.';
                    customConfig.hide();
                    break;
                case 'custom':
                    infoText = '<i class="fa fa-cog"></i> <strong>Custom Format:</strong> User-defined format with timezone support. Use format tokens like DD, MM, YYYY, HH, mm, ss.';
                    customConfig.show();
                    break;
            }
            
            infoElement.html(infoText);
        });
        
        // Initialize output format
        $('#node-input-outputFormat').trigger('change');
        
        // Initialize query mode
        $('#node-input-queryMode').trigger('change');
        
        // Initialize data format
        $('#node-input-dataFormat').trigger('change');
        
        // Initialize timestamp format
        $('#node-input-timestampFormat').trigger('change');
        
        // History adapter suggestions
        initializeHistoryAdapterSuggestions();
        
        // Load TreeView component
        loadSharedTreeView().then(() => {
            node.treeController = window.ioBrokerSharedTreeView.setup({
                nodeType: 'iobhistory',
                inputId: 'node-input-stateId',
                serverInputId: 'node-input-server',
                searchPlaceholder: 'Search states for history...',
                itemType: 'states',
                dataEndpoint: '/iobroker/ws/states',
                enableWildcardDetection: false
            });
        }).catch(error => {
            console.error('Failed to load TreeView component:', error);
        });
    },

    oneditsave: function() {
        if (this.treeController) {
            this.treeController.cleanup();
        }
    }
});
</script>

<script type="text/html" data-template-name="iobhistory">
    <style>
        .node-config-tabs {
            list-style: none;
            padding: 0;
            margin: 0 0 15px 0;
            display: flex;
            border-bottom: 2px solid #ddd;
            background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
            border-radius: 6px 6px 0 0;
        }
        
        .node-config-tabs li {
            flex: 1;
            text-align: center;
            cursor: pointer;
            padding: 12px 8px;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 13px;
        }
        
        .node-config-tabs li:first-child {
            border-radius: 6px 0 0 0;
        }
        
        .node-config-tabs li:last-child {
            border-right: none;
            border-radius: 0 6px 0 0;
        }
        
        .node-config-tabs li:hover {
            background: #e2e6ea;
        }
        
        .node-config-tabs li.active {
            background: white;
            color: #007bff;
            border-bottom: 2px solid #007bff;
            font-weight: 600;
        }
        
        .tab-content {
            min-height: 400px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        .tab-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .tab-section h4 {
            margin: 0 0 12px 0;
            color: #495057;
            font-size: 14px;
            font-weight: 600;
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 6px;
        }
        
        .form-row {
            margin-bottom: 12px;
        }
        
        .form-row:last-child {
            margin-bottom: 0;
        }
        
        .adapter-suggestions {
            margin-top: 8px;
            padding: 8px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 12px;
        }
        .adapter-suggestions a {
            display: inline-block;
            margin: 2px 8px 2px 0;
            padding: 4px 8px;
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 3px;
            text-decoration: none;
            color: #495057;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .adapter-suggestions a:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        .adapter-suggestions a.selected {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }
        .adapter-suggestions a.alive {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .adapter-suggestions a.enabled {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .adapter-suggestions a.disabled {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
            opacity: 0.7;
        }
        .adapter-suggestions a.fallback {
            background-color: #f8f9fa;
            border-color: #dee2e6;
            color: #6c757d;
            border-style: dashed;
        }
        
        .time-range-options {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-top: 8px;
        }
        
        .time-range-options label {
            font-weight: normal;
            margin-right: 15px;
        }
        
        .output-format-info, .data-format-info, .timestamp-format-info {
            margin-top: 8px;
            padding: 8px;
            background-color: #e8f4fd;
            border: 1px solid #bee5eb;
            border-radius: 4px;
            font-size: 12px;
            color: #0c5460;
        }
        
        .checkbox-help {
            margin-top: 4px;
            color: #6c757d;
            font-size: 12px;
        }
    </style>

    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Optional node name">
    </div>

    <ul class="node-config-tabs">
        <li data-tab="datasource">üìä Data Source</li>
        <li data-tab="timerange">üïê Time Range</li>
        <li data-tab="processing">‚öôÔ∏è Processing</li>
        <li data-tab="output">üì§ Output</li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane" data-tab="datasource">
            <div class="tab-section">
                <h4>State Configuration</h4>
                <div class="form-row">
                    <label for="node-input-stateId"><i class="icon-tag"></i> State ID</label>
                    <input type="text" id="node-input-stateId" placeholder="e.g. system.adapter.admin.0.memRss (if empty, msg.topic is used)">
                </div>
            </div>
            
            <div class="tab-section">
                <h4>History Adapter</h4>
                <div class="form-row">
                    <label for="node-input-historyAdapter"><i class="icon-tag"></i> Adapter Instance</label>
                    <input type="text" id="node-input-historyAdapter" placeholder="e.g. history.0, sql.1, influxdb.2">
                    <div class="adapter-suggestions" style="display: none;">
                        <span style="font-size: 12px; color: #666;">Available adapters: </span>
                        <span class="adapter-list" style="font-size: 12px;"></span>
                    </div>
                </div>
            </div>
            
            <div class="tab-section">
                <h4>Server Connection</h4>
                <div class="form-row">
                    <label for="node-input-server"><i class="icon-tag"></i> ioBroker Server</label>
                    <input type="text" id="node-input-server">
                </div>
            </div>
        </div>

        <div class="tab-pane" data-tab="timerange">
            <div class="tab-section">
                <h4>Time Range Mode</h4>
                <div class="time-range-options">
                    <label><input type="radio" name="timeRangeMode" value="duration"> Duration from now</label>
                    <label><input type="radio" name="timeRangeMode" value="absolute"> Absolute time period</label>
                    <label><input type="radio" name="timeRangeMode" value="message"> From message properties</label>
                </div>
                <input type="hidden" id="node-input-timeRange">
            </div>
            
            <div class="time-config-section duration">
                <div class="tab-section">
                    <h4>Duration Settings</h4>
                    <div class="form-row">
                        <label for="node-input-duration"><i class="icon-clock-o"></i> Duration</label>
                        <input type="number" id="node-input-duration" style="width: 100px;" min="1">
                        <select id="node-input-durationUnit" style="width: 100px; margin-left: 5px;">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                            <option value="weeks">Weeks</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="time-config-section absolute">
                <div class="tab-section">
                    <h4>Absolute Time Period</h4>
                    <div class="form-row">
                        <label for="node-input-startTime"><i class="icon-calendar"></i> Start Time</label>
                        <input type="datetime-local" id="node-input-startTime" style="width: 200px;">
                    </div>
                    <div class="form-row">
                        <label for="node-input-endTime"><i class="icon-calendar"></i> End Time</label>
                        <input type="datetime-local" id="node-input-endTime" style="width: 200px;">
                    </div>
                </div>
            </div>
            
            <div class="time-config-section message">
                <div class="tab-section">
                    <h4>Message Properties</h4>
                    <div style="color: #0c5460; font-size: 13px;">
                        <i class="fa fa-info-circle"></i> Time range will be read from message properties:
                        <ul style="margin: 8px 0 0 20px;">
                            <li><code>msg.start</code> - Start timestamp (ISO string or milliseconds)</li>
                            <li><code>msg.end</code> - End timestamp (ISO string or milliseconds)</li>
                            <li><code>msg.duration</code> - Duration in hours (alternative to end)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-pane" data-tab="processing">
            <div class="tab-section">
                <h4>Query Processing</h4>
                <div class="form-row">
                    <label for="node-input-queryMode"><i class="icon-cogs"></i> Query Mode</label>
                    <select id="node-input-queryMode" style="width:100%">
                        <option value="parallel">Parallel - Allow multiple simultaneous queries</option>
                        <option value="sequential">Sequential - Queue queries and process one by one</option>
                        <option value="drop">Drop - Discard new queries while one is running</option>
                    </select>
                    <div id="query-mode-info" style="margin-top: 8px; padding: 8px; background-color: #e8f4fd; border: 1px solid #bee5eb; border-radius: 4px; font-size: 12px; color: #0c5460;">
                    </div>
                </div>
            </div>
            
            <div class="tab-section">
                <h4>Data Aggregation</h4>
                <div class="form-row">
                    <label for="node-input-aggregate"><i class="icon-cog"></i> Aggregation Method</label>
                    <select id="node-input-aggregate" style="width:100%">
                        <option value="none">None (Raw Data)</option>
                        <option value="onchange">On Change</option>
                        <option value="average">Average</option>
                        <option value="min">Minimum</option>
                        <option value="max">Maximum</option>
                        <option value="minmax">Min/Max Pairs</option>
                        <option value="total">Total/Sum</option>
                        <option value="count">Count</option>
                        <option value="percentile">Percentile</option>
                        <option value="quantile">Quantile</option>
                        <option value="integral">Integral</option>
                    </select>
                </div>
                
                <div class="form-row" id="step-config" style="display: none;">
                    <label for="node-input-step"><i class="icon-clock-o"></i> Step Interval</label>
                    <input type="number" id="node-input-step" style="width: 100px;" min="1">
                    <select id="node-input-stepUnit" style="width: 100px; margin-left: 5px;">
                        <option value="seconds">Seconds</option>
                        <option value="minutes">Minutes</option>
                        <option value="hours">Hours</option>
                    </select>
                </div>
                
                <div class="form-row aggregate-option" id="percentile-config" style="display: none;">
                    <label for="node-input-percentile"><i class="icon-tag"></i> Percentile</label>
                    <input type="number" id="node-input-percentile" style="width: 100px;" min="0" max="100" value="50">
                    <span style="margin-left: 5px; font-size: 12px; color: #666;">% (0-100)</span>
                </div>
                
                <div class="form-row aggregate-option" id="quantile-config" style="display: none;">
                    <label for="node-input-quantile"><i class="icon-tag"></i> Quantile</label>
                    <input type="number" id="node-input-quantile" style="width: 100px;" min="0" max="1" step="0.01" value="0.5">
                    <span style="margin-left: 5px; font-size: 12px; color: #666;">(0-1)</span>
                </div>
                
                <div class="form-row aggregate-option" id="integral-config" style="display: none;">
                    <label for="node-input-integralUnit"><i class="icon-tag"></i> Integral Unit</label>
                    <select id="node-input-integralUnit" style="width: 150px;">
                        <option value="1">Seconds</option>
                        <option value="60">Minutes</option>
                        <option value="3600">Hours</option>
                        <option value="86400">Days</option>
                    </select>
                </div>
            </div>
            
            <div class="tab-section">
                <h4>Data Limits</h4>
                <div class="form-row">
                    <label for="node-input-maxEntries"><i class="icon-list"></i> Max Entries</label>
                    <input type="number" id="node-input-maxEntries" style="width: 100px;" min="1" max="100000">
                    <span style="margin-left: 5px; font-size: 12px; color: #666;">Default: 2000</span>
                </div>
            </div>
        </div>

        <div class="tab-pane" data-tab="output">
            <div class="tab-section">
                <h4>Output Configuration</h4>
                <div class="form-row">
                    <label for="node-input-outputProperty"><i class="icon-tag"></i> Output Property</label>
                    <input type="text" id="node-input-outputProperty" placeholder="payload">
                </div>
                
                <div class="form-row">
                    <label for="node-input-outputFormat"><i class="icon-list-alt"></i> Output Format</label>
                    <select id="node-input-outputFormat" style="width:100%">
                        <option value="array">Array of Data Points</option>
                        <option value="chart">Chart.js Format</option>
                        <option value="dashboard2">Dashboard 2.0 Format</option>
                        <option value="statistics">Statistics Summary</option>
                    </select>
                </div>
                
                <div class="output-format-info array" style="display: none;">
                    <i class="fa fa-info-circle"></i> <strong>Array Format:</strong> Returns raw data points as array: <code>[{val, ts, ack, from}, ...]</code>
                </div>
                
                <div class="output-format-info chart" style="display: none;">
                    <i class="fa fa-info-circle"></i> <strong>Chart.js Format:</strong> Returns Chart.js dataset: <code>{labels: [], datasets: [{data: [], label: ""}]}</code>
                </div>
                
                <div class="output-format-info dashboard2" style="display: none;">
                    <i class="fa fa-info-circle"></i> <strong>Dashboard 2.0 Format:</strong> Returns ui-chart compatible data: <code>[{x: timestamp, y: value}, ...]</code> with <code>msg.topic</code> as series name. Configure ui-chart: X="x", Y="y"
                </div>
                
                <div class="output-format-info statistics" style="display: none;">
                    <i class="fa fa-info-circle"></i> <strong>Statistics Format:</strong> Returns summary: <code>{count, min, max, avg, first, last, timeRange}</code>
                </div>
            </div>
            
            <div class="tab-section">
                <h4>Data Format Options</h4>
                <div class="form-row">
                    <label for="node-input-removeBorderValues" style="width: auto;">
                        <input type="checkbox" id="node-input-removeBorderValues" style="width: auto; margin-right: 5px;">
                        Remove Border Values
                    </label>
                    <div class="checkbox-help">
                        Exclude data points exactly at start/end boundaries
                    </div>
                </div>
                              
                <div class="form-row">
                    <label for="node-input-timestampFormat"><i class="icon-clock-o"></i> Timestamp Format</label>
                    <select id="node-input-timestampFormat" style="width:100%">
                        <option value="unix">Unix timestamp (milliseconds)</option>
                        <option value="iso">ISO 8601 string (UTC)</option>
                        <option value="custom">Custom format</option>
                    </select>
                    <div id="timestamp-format-info" class="timestamp-format-info" style="display: none;">
                    </div>
                </div>
                
                <div class="form-row" id="custom-format-config" style="display: none;">
                    <label for="node-input-customTimeFormat"><i class="icon-clock-o"></i> Custom Format</label>
                    <input type="text" id="node-input-customTimeFormat" style="width: 200px;" placeholder="DD.MM.YYYY HH:mm:ss">
                    <select id="node-input-timezone" style="width: 150px; margin-left: 5px;">
                        <option value="auto">Auto (local)</option>
                        <option value="UTC">UTC</option>
                        <option value="Europe/Berlin">Europe/Berlin</option>
                        <option value="Europe/London">Europe/London</option>
                        <option value="America/New_York">America/New_York</option>
                        <option value="America/Los_Angeles">America/Los_Angeles</option>
                        <option value="Asia/Tokyo">Asia/Tokyo</option>
                        <option value="Australia/Sydney">Australia/Sydney</option>
                    </select>
                    <div style="margin-top: 4px; color: #6c757d; font-size: 12px;">
                        Format examples: DD.MM.YYYY HH:mm:ss, MM/DD/YYYY h:mm A, YYYY-MM-DD HH:mm
                    </div>
                </div>
                
                <div class="form-row">
                    <label for="node-input-dataFormat"><i class="icon-list"></i> Data Format</label>
                    <select id="node-input-dataFormat" style="width:100%">
                        <option value="full">Full data (ts, val, ack, from, ...)</option>
                        <option value="simple">Simple data (ts, val only)</option>
                    </select>
                    <div id="data-format-info" class="data-format-info" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</script>

<script type="text/html" data-help-name="iobhistory">
    <p>ioBroker historical data retrieval via WebSocket</p>
    
    <h3>Configuration</h3>
    <p>The node configuration is organized into four main sections:</p>
    
    <h4>üìä Data Source</h4>
    <ul>
        <li><b>State ID:</b> The ioBroker state to query. If empty, <code>msg.topic</code> is used.</li>
        <li><b>History Adapter:</b> Which history adapter instance to query (auto-discovered with status indicators)</li>
        <li><b>Server:</b> ioBroker server connection configuration</li>
    </ul>
    
    <h4>üïê Time Range</h4>
    <ul>
        <li><b>Duration:</b> Last X hours/days from now</li>
        <li><b>Absolute:</b> Fixed start and end times</li>
        <li><b>From Message:</b> Use msg.start, msg.end, or msg.duration</li>
    </ul>
    
    <h4>‚öôÔ∏è Processing</h4>
    <ul>
        <li><b>Query Mode:</b> How to handle multiple simultaneous queries:
            <ul>
                <li><b>Parallel:</b> Allow multiple queries to run simultaneously (default)</li>
                <li><b>Sequential:</b> Queue queries and process them one by one</li>
                <li><b>Drop:</b> Discard new queries while one is already running</li>
            </ul>
        </li>
        <li><b>Aggregation:</b> How to process the data (none, average, min/max, etc.)</li>
        <li><b>Step Interval:</b> Time interval for aggregation</li>
        <li><b>Max Entries:</b> Limit number of returned data points</li>
    </ul>
    
    <h4>üì§ Output</h4>
    <ul>
        <li><b>Output Property:</b> Where to place the result in the message</li>
        <li><b>Output Format:</b> Format of the returned data (Array, Chart.js, Dashboard 2.0, Statistics)</li>
        <li><b>Remove Border Values:</b> Exclude data points exactly at start/end boundaries</li>
        <li><b>Timestamp Format:</b> Unix timestamp, ISO 8601 string, or custom format</li>
        <li><b>Data Format:</b> Full data with all properties or simple data with only ts and val</li>
    </ul>
    
    <h3>Input</h3>
    <p>Trigger history query on any input. Optional message properties:</p>
    <ul>
        <li><code>msg.topic</code> - State ID (if not configured)</li>
        <li><code>msg.start</code> - Start time (ISO string or timestamp in ms)</li>
        <li><code>msg.end</code> - End time (ISO string or timestamp in ms)</li>
        <li><code>msg.duration</code> - Duration in hours (alternative to end time)</li>
        <li><code>msg.aggregate</code> - Override aggregation method</li>
        <li><code>msg.step</code> - Override step interval (in seconds)</li>
        <li><code>msg.maxEntries</code> - Override max entries limit</li>
        <li><code>msg.removeBorderValues</code> - Override border values setting</li>
        <li><code>msg.timestampFormat</code> - Override timestamp format ("unix", "iso", "custom")</li>
        <li><code>msg.customTimeFormat</code> - Custom format string (e.g., "DD.MM.YYYY HH:mm:ss")</li>
        <li><code>msg.timezone</code> - Timezone for custom format ("auto", "UTC", "Europe/Berlin", etc.)</li>
        <li><code>msg.dataFormat</code> - Override data format ("full" or "simple")</li>
    </ul>
    
    <h3>Output</h3>
    <p>Historical data in the specified format plus additional properties:</p>
    <ul>
        <li><code>msg.stateId</code> - The queried state ID</li>
        <li><code>msg.adapter</code> - History adapter used</li>
        <li><code>msg.queryOptions</code> - Complete query options used</li>
        <li><code>msg.queryTime</code> - Time taken for the query (ms)</li>
        <li><code>msg.count</code> - Number of data points returned</li>
        <li><code>msg.queryId</code> - Unique ID for this query</li>
        <li><code>msg.queryMode</code> - Query processing mode used</li>
        <li><code>msg.dropped</code> - True if query was dropped (drop mode only)</li>
        <li><code>msg.error</code> - Error message if query failed</li>
    </ul>
    
    <h3>Timestamp Format Options</h3>
    <ul>
        <li><b>Unix Timestamp:</b> Milliseconds since epoch (e.g., 1609459200000). Standard for JavaScript Date objects.</li>
        <li><b>ISO 8601 String:</b> UTC format (e.g., "2021-01-01T00:00:00.000Z"). International standard.</li>
        <li><b>Custom Format:</b> User-defined format with timezone support. Format tokens:
            <ul>
                <li>YYYY - 4-digit year</li>
                <li>MM - 2-digit month</li>
                <li>DD - 2-digit day</li>
                <li>HH - 2-digit hour (24-hour)</li>
                <li>mm - 2-digit minute</li>
                <li>ss - 2-digit second</li>
                <li>h - 12-hour format</li>
                <li>A - AM/PM</li>
            </ul>
        </li>
    </ul>
    
    <h3>Query Modes</h3>
    <p>The node supports three different query processing modes:</p>
    
    <h4>Parallel Mode (Default)</h4>
    <ul>
        <li>Multiple queries can run simultaneously</li>
        <li>Fastest processing for single queries</li>
        <li>May overload history adapter with many concurrent requests</li>
        <li>Best for: Low-frequency queries or powerful ioBroker systems</li>
    </ul>
    
    <h4>Sequential Mode</h4>
    <ul>
        <li>Queries are processed one after another in order</li>
        <li>All queries are executed, none are lost</li>
        <li>Slower overall processing but more reliable</li>
        <li>Queue status shown in node status</li>
        <li>Best for: High-frequency queries or limited system resources</li>
    </ul>
    
    <h4>Drop Mode</h4>
    <ul>
        <li>New queries are discarded while one is running</li>
        <li>Only the currently running query completes</li>
        <li>Dropped queries receive an error response with <code>msg.dropped = true</code></li>
        <li>Best for: UI updates where only the latest result matters</li>
    </ul>
    
    <h3>Use Cases</h3>
    <ul>
        <li>Energy consumption analysis and reporting</li>
        <li>Temperature trending and statistics</li>
        <li>System performance monitoring</li>
        <li>Data visualization with Chart.js or Dashboard 2.0</li>
        <li>Historical data export and backup</li>
    </ul>
</script>