<script type="text/javascript">
RED.nodes.registerType('iobsendto', {
    category: 'ioBroker WS',
    color: '#a6bbcf',
    defaults: {
        name: { value: "" },
        adapter: { value: "" },
        command: { value: "" },
        message: { value: "" },
        waitForResponse: { value: false },
        responseTimeout: { value: 10000 },
        server: { value: "", type: "iob-config" }
    },
    inputs: 1,
    outputs: 1,
    icon: "iobroker_sendto.svg",
    paletteLabel: "WS ioB sendTo",
    label: function() {
        if (this.name) return this.name;
        
        let label = this.adapter || "iob-sendto";
        if (this.command) {
            label += ` (${this.command})`;
        }
        return label;
    },
    
    oneditprepare: function() {
        const serverInput = $('#node-input-server');
        
        if (!this.server || this.server === '') {
            const configNodes = [];
            RED.nodes.eachConfig(function(config) {
                if (config.type === 'iob-config') {
                    configNodes.push(config);
                }
            });
            
            if (configNodes.length === 1) {
                this.server = configNodes[0].id;
                serverInput.val(this.server);
                
                setTimeout(() => {
                    RED.notify(`Automatically selected server: ${configNodes[0].name || configNodes[0].iobhost}`, {
                        type: "info",
                        timeout: 1500
                    });
                }, 500);
            }
        }
        
        $('#node-input-waitForResponse').on('change', function() {
            const isChecked = $(this).prop('checked');
            $('#response-timeout-container').toggle(isChecked);
            $('#response-info').toggle(isChecked);
            
            if (isChecked) {
                $('#no-response-info').hide();
            } else {
                $('#no-response-info').show();
            }
        });
        
        const waitForResponseChecked = $('#node-input-waitForResponse').prop('checked');
        $('#response-timeout-container').toggle(waitForResponseChecked);
        $('#response-info').toggle(waitForResponseChecked);
        $('#no-response-info').toggle(!waitForResponseChecked);
        
        $('#add-common-example').on('click', function() {
            const examples = [
                { adapter: 'telegram.0', command: 'send', desc: 'Telegram notification' },
                { adapter: 'email', command: '', desc: 'Email notification' },
                { adapter: 'sql.0', command: 'query', desc: 'SQL database query' },
                { adapter: 'javascript.0', command: 'toScript', desc: 'Execute JavaScript' },
                { adapter: 'spotify-premium.0', command: 'play', desc: 'Spotify control' },
                { adapter: 'pushover.0', command: '', desc: 'Pushover notification' }
            ];
            
            const randomExample = examples[Math.floor(Math.random() * examples.length)];
            $('#node-input-adapter').val(randomExample.adapter);
            $('#node-input-command').val(randomExample.command);
            
            RED.notify(`Example: ${randomExample.desc}`, { type: "info", timeout: 2000 });
        });
    },
    
    oneditresize: function() {
    }
});
</script>

<script type="text/html" data-template-name="iobsendto">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    
    <div class="form-row">
        <label for="node-input-adapter"><i class="icon-tag"></i> Target Adapter</label>
        <input type="text" id="node-input-adapter" placeholder="e.g. telegram.0, email, sql.0 (if empty, msg.adapter is used)">
        <button type="button" id="add-common-example" class="editor-button editor-button-small" style="margin-top: 5px;">
            <i class="fa fa-lightbulb-o"></i> Add common example
        </button>
    </div>
    
    <div class="form-row">
        <label for="node-input-command"><i class="icon-tag"></i> Command</label>
        <input type="text" id="node-input-command" placeholder="e.g. send, query, toScript (optional, can be empty)">
    </div>
    
    <div class="form-row">
        <label for="node-input-message"><i class="icon-tag"></i> Static Message</label>
        <textarea id="node-input-message" rows="4" style="width:100%; font-family: monospace;" placeholder="Optional JSON message (leave empty to use msg.payload)"></textarea>
        <div style="margin-top: 5px; font-size: 12px; color: #666;">
            If empty, <code>msg.payload</code> will be used as the message content
        </div>
    </div>
    
    <div class="form-row">
        <label for="node-input-waitForResponse" style="width: auto;">
            <input type="checkbox" id="node-input-waitForResponse" style="width: auto; margin-right: 5px;">
            <i class="icon-tag"></i> Wait for response
        </label>
    </div>
    
    <div class="form-row" id="response-timeout-container" style="display: none;">
        <label for="node-input-responseTimeout"><i class="icon-tag"></i> Response Timeout</label>
        <input type="number" id="node-input-responseTimeout" style="width: 120px;" min="1000" max="60000" step="1000"> ms
    </div>
    
    <div id="response-info" style="display: none; margin-top: 5px; padding: 8px; background-color: #e8f4fd; border: 1px solid #bee5eb; border-radius: 4px; font-size: 12px; color: #0c5460;">
        <i class="fa fa-info-circle"></i> <strong>Response Mode:</strong><br>
        Node will wait for adapter response and send it as output message. Useful for queries and commands that return data.
    </div>
    
    <div id="no-response-info" style="margin-top: 5px; padding: 8px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; font-size: 12px; color: #856404;">
        <i class="fa fa-info-circle"></i> <strong>Fire-and-forget Mode:</strong><br>
        Node will send the command and not wait for response. No output will be generated.
    </div>
    
    <div class="form-row">
        <label for="node-input-server"><i class="icon-tag"></i> Server</label>
        <input type="text" id="node-input-server">
    </div>
</script>

<script type="text/html" data-help-name="iobsendto">
    <p>ioBroker sendTo command via WebSocket for adapter-to-adapter communication and service integration.</p>
    
    <h3>Configuration</h3>
    <ul>
        <li><b>Target Adapter:</b> The adapter instance to send command to. If empty, <code>msg.adapter</code> is used.</li>
        <li><b>Command:</b> Optional command parameter. Some adapters require this, others don't.</li>
        <li><b>Static Message:</b> Optional JSON message to send. If empty, <code>msg.payload</code> is used.</li>
        <li><b>Wait for Response:</b> Enable to receive adapter response as output message.</li>
        <li><b>Response Timeout:</b> Maximum time to wait for response (1-60 seconds).</li>
        <li><b>Server:</b> The ioBroker server configuration.</li>
    </ul>
    
    <h3>Input Message</h3>
    <p>Message properties that can override node configuration:</p>
    <ul>
        <li><code>msg.adapter</code> - Target adapter (overrides node setting)</li>
        <li><code>msg.command</code> - Command parameter (overrides node setting)</li>
        <li><code>msg.message</code> - Message content (overrides node setting and msg.payload)</li>
        <li><code>msg.payload</code> - Used as message if no static message configured</li>
        <li><code>msg.timeout</code> - Response timeout in milliseconds (overrides node setting)</li>
    </ul>
    
    <h3>Common Use Cases</h3>
    
    <h4>Telegram Notifications</h4>
    <pre>// Node config: adapter="telegram.0", command="send"
msg.payload = {
    text: "Motion detected in living room!",
    user: "admin"
}</pre>
    
    <h4>Email Alerts</h4>
    <pre>// Node config: adapter="email", command=""
msg.payload = {
    to: "admin@home.com",
    subject: "System Alert",
    text: "Temperature critical: 85Â°C"
}</pre>
    
    <h4>SQL Database Queries</h4>
    <pre>// Node config: adapter="sql.0", command="query", waitForResponse=true
msg.payload = "SELECT * FROM datapoints WHERE ts > NOW() - INTERVAL 1 DAY"</pre>
    
    <h4>JavaScript Execution</h4>
    <pre>// Node config: adapter="javascript.0", command="toScript"
msg.payload = {
    script: "myScript",
    message: { action: "cleanup", data: [1,2,3] }
}</pre>
    
    <h4>Media Control</h4>
    <pre>// Node config: adapter="spotify-premium.0", command="play"
msg.payload = {
    playlist: "Morning Music",
    volume: 60
}</pre>
    
    <h3>Output (Response Mode)</h3>
    <p>When "Wait for Response" is enabled:</p>
    <ul>
        <li><code>msg.payload</code> - Adapter response data</li>
        <li><code>msg.adapter</code> - Target adapter that was called</li>
        <li><code>msg.command</code> - Command that was sent</li>
        <li><code>msg.originalMessage</code> - Original message sent to adapter</li>
        <li><code>msg.responseTime</code> - Time taken for response (ms)</li>
        <li><code>msg.timestamp</code> - When response was received</li>
    </ul>
    
    <h3>Error Handling</h3>
    <ul>
        <li>Missing adapter specification triggers error</li>
        <li>Response timeouts generate error messages</li>
        <li>Invalid JSON in static message triggers validation error</li>
        <li>Connection issues are handled by underlying WebSocket manager</li>
    </ul>
    
    <h3>Adapter Compatibility</h3>
    <p>Works with any ioBroker adapter that supports sendTo messages:</p>
    <ul>
        <li><b>Notifications:</b> telegram, pushover, email, slack</li>
        <li><b>Databases:</b> sql, influxdb, history</li>
        <li><b>Media:</b> spotify, sonos, kodi</li>
        <li><b>Scripts:</b> javascript, node-red</li>
        <li><b>Services:</b> weather, calendar, backup</li>
    </ul>
    
    <h3>Performance Notes</h3>
    <ul>
        <li>Fire-and-forget mode is faster for simple notifications</li>
        <li>Response mode adds latency but provides feedback</li>
        <li>Timeout values should match expected adapter response times</li>
        <li>Avoid very short timeouts that may cause false failures</li>
    </ul>
</script>