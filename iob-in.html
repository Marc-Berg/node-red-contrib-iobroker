<script type="text/javascript">
RED.nodes.registerType('iobin', {
    category: 'ioBroker',
    color: '#a6bbcf',
    defaults: {
        name: { value: "" },
        state: { value: "", required: true },
        outputProperty: { value: "payload" },
        ackFilter: { value: "both" },
        server: { value: "", type: "iob-config" }
    },
    inputs: 0,
    outputs: 1,
    icon: "iobroker_in.svg",
    label: function() {
        return this.name || this.state || "iob-in";
    },
    oneditprepare: function() {
        const node = this;

        // UI elements for tree browser
        const treeContainer = $('<div class="iob-tree-container"></div>');
        const toggleButton = $('<button id="toggle-input" class="red-ui-button">Switch to tree selection</button>');
        const searchContainer = $('<div class="iob-search-container" style="display:none;"><input type="text" id="iob-search" placeholder="Search states..." class="red-ui-searchbox-input" style="width:100%;margin-bottom:10px;"></div>');
        const statusElement = $('<div class="iob-status"></div>');

        $('#node-input-state').after(toggleButton).after(searchContainer).after(treeContainer).after(statusElement);

        let treeData = {};
        let filteredData = {};
        let searchTimeout;
        let statesLoaded = false;

        // Helper: Escape RegExp
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        // Build tree structure
        function buildTreeStructure(data) {
            const tree = {};
            const states = Object.keys(data);
            states.forEach(id => {
                const parts = id.split('.');
                let currentNode = tree;
                parts.forEach((part, index) => {
                    if (!currentNode[part]) {
                        currentNode[part] = {
                            children: {},
                            isLeaf: false,
                            path: parts.slice(0, index + 1).join('.'),
                            fullId: index === parts.length - 1 ? id : null
                        };
                    }
                    if (index === parts.length - 1) {
                        currentNode[part].isLeaf = true;
                        currentNode[part].fullId = id;
                    }
                    currentNode = currentNode[part].children;
                });
            });
            return tree;
        }

        // Render tree
        function renderTree(node, searchTerm = '') {
            const fragment = document.createDocumentFragment();
            Object.keys(node)
                .sort((a, b) => {
                    const aIsFolder = !node[a].isLeaf;
                    const bIsFolder = !node[b].isLeaf;
                    if (aIsFolder !== bIsFolder) return bIsFolder - aIsFolder;
                    return a.localeCompare(b, undefined, { numeric: true });
                })
                .forEach(key => {
                    const child = node[key];
                    const li = document.createElement('li');
                    const displayKey = searchTerm && key.toLowerCase().includes(searchTerm.toLowerCase())
                        ? key.replace(new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi'), '<mark>$1</mark>')
                        : key;
                    li.className = child.isLeaf ? 'leaf' : 'folder';
                    li.dataset.path = child.path;
                    li.dataset.fullId = child.fullId || '';
                    li.innerHTML = `
                        <span class="iob-tree-icon" aria-label="${child.isLeaf ? 'State' : 'Folder'}"></span>
                        <span class="iob-tree-label" title="${child.path}">${displayKey}</span>
                    `;
                    if (!child.isLeaf && Object.keys(child.children).length > 0) {
                        const ul = document.createElement('ul');
                        ul.appendChild(renderTree(child.children, searchTerm));
                        li.appendChild(ul);
                    }
                    fragment.appendChild(li);
                });
            return fragment;
        }

        // Search with debounce
        function handleSearch(searchTerm) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                if (!searchTerm.trim()) {
                    filteredData = treeData;
                } else {
                    filteredData = {};
                    Object.keys(treeData).forEach(key => {
                        if (key.toLowerCase().includes(searchTerm.toLowerCase())) {
                            const parts = key.split('.');
                            let currentNode = filteredData;
                            parts.forEach((part, index) => {
                                if (!currentNode[part]) {
                                    currentNode[part] = {
                                        children: {},
                                        isLeaf: false,
                                        path: parts.slice(0, index + 1).join('.'),
                                        fullId: index === parts.length - 1 ? key : null
                                    };
                                }
                                if (index === parts.length - 1) {
                                    currentNode[part].isLeaf = true;
                                    currentNode[part].fullId = key;
                                }
                                currentNode = currentNode[part].children;
                            });
                        }
                    });
                }
                const treeElement = treeContainer.find('.iob-tree')[0];
                if (treeElement) {
                    treeElement.innerHTML = '';
                    treeElement.appendChild(renderTree(filteredData, searchTerm));
                }
            }, 300);
        }

        $('#iob-search').on('input', function() {
            handleSearch($(this).val());
        });

        // Event handlers
        function setupEventHandlers() {
            // Folder toggle
            treeContainer.off('click').on('click', '.folder', function(e) {
                if ($(e.target).hasClass('iob-tree-label') || $(e.target).hasClass('iob-tree-icon')) {
                    e.stopPropagation();
                    const $li = $(this);
                    const $ul = $li.children('ul').first();
                    const $icon = $li.find('.iob-tree-icon').first();
                    if ($ul.length) {
                        $ul.slideToggle(200);
                        $icon.toggleClass('open');
                        $li.toggleClass('open');
                    }
                }
            });
            // State selection
            treeContainer.on('dblclick', '.leaf', function(e) {
                e.stopPropagation();
                const fullId = $(this).data('full-id') || $(this).data('path');
                $('#node-input-state').val(fullId).trigger('change');
                RED.notify(`State selected: ${fullId}`, { type: "success", timeout: 2000 });
                setTimeout(() => toggleInputMode(), 500);
            });
            // Visual feedback on click
            treeContainer.on('click', '.leaf', function(e) {
                e.stopPropagation();
                $('.iob-tree li').removeClass('selected');
                $(this).addClass('selected');
            });
        }

        // Toggle between manual and tree input
        function toggleInputMode() {
            const isManualVisible = $('#node-input-state').is(':visible');
            $('#node-input-state').toggle(!isManualVisible);
            treeContainer.toggle(isManualVisible);
            searchContainer.toggle(isManualVisible);
            if (!isManualVisible) {
                    statusElement.hide();
            }
            toggleButton.text(isManualVisible ? 'Switch to manual input' : 'Switch to tree selection');
            if (isManualVisible && !statesLoaded) {
                loadTree();
            }
        }
        toggleButton.on('click', toggleInputMode);

        // Load tree using WebSocket-based endpoint
        async function loadTree() {
            const serverNode = RED.nodes.node($('#node-input-server').val());
            if (!serverNode) {
                treeContainer.html('<div class="iob-error">No server selected</div>');
                statusElement.html('<span class="iob-status iob-status-error"><i class="fa fa-exclamation-triangle"></i> No server selected</span>');
                return;
            }

            treeContainer.html('<div class="iob-loading"><i class="fa fa-spinner fa-spin"></i> Loading states...</div>');
            statusElement.html('<span class="iob-status iob-status-info"><i class="fa fa-spinner fa-spin"></i> Loading states from ioBroker via WebSocket...</span>');

            try {
                const serverId = encodeURIComponent(`${serverNode.iobhost}:${serverNode.iobport}`);
                const response = await $.ajax({
                    url: `/iobroker/ws/states/${serverId}`,
                    method: 'GET',
                    timeout: 15000,
                    dataType: 'json'
                });
                
                if (!response || typeof response !== 'object') {
                    throw new Error('Invalid response format');
                }

                const stateCount = Object.keys(response).length;
                if (stateCount === 0) {
                    throw new Error('No states received from server');
                }

                treeData = response;
                filteredData = response;
                const treeStructure = buildTreeStructure(response);
                const treeHtml = $('<ul class="iob-tree"></ul>')[0];
                treeHtml.appendChild(renderTree(treeStructure));
                treeContainer.empty().append(treeHtml);
                setupEventHandlers();
                statesLoaded = true;
                statusElement.html(`<span class="iob-status iob-status-success"><i class="fa fa-check-circle"></i> Loaded ${stateCount} states</span>`);
                
            } catch (error) {
                console.error('Tree loading error:', error);
                let errorMessage = 'Unknown error';
                
                if (error.status === 404) {
                    errorMessage = 'WebSocket endpoint not found';
                } else if (error.status === 500) {
                    errorMessage = 'Server error loading states';
                } else if (error.timeout) {
                    errorMessage = 'Connection timeout';
                } else if (error.statusText) {
                    errorMessage = error.statusText;
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                treeContainer.html(`<div class="iob-error">Error loading states: ${errorMessage}<br><small>Check server connection and try again</small></div>`);
                statusElement.html('<span class="iob-status iob-status-error"><i class="fa fa-exclamation-triangle"></i> Error loading states</span>');
            }
        }

        // Server change handler
        $('#node-input-server').on('change', function() {
            treeData = {};
            filteredData = {};
            statesLoaded = false;
            statusElement.html('');
            if (treeContainer.is(':visible')) {
                loadTree();
            }
        });

        // Initial load if server is already set and tree is visible
        if ($('#node-input-server').val() && treeContainer.is(':visible')) {
            loadTree();
        }
    },

    oneditsave: function() {
        $('#node-input-state').show();
        $('.iob-tree-container, #toggle-input, .iob-search-container, .iob-status').remove();
    }
});
</script>

<style>
.iob-tree-container {
    max-height: 250px;
    overflow-y: auto;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 8px;
    margin-top: 5px;
    background: #fafafa;
    display: none;
}
.iob-search-container {
    margin-top: 5px;
}
.iob-status {
    padding: 5px 10px;
    border-radius: 3px;
    font-size: 12px;
    font-weight: bold;
    margin-top: 5px;
}
.iob-status-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}
.iob-status-info {
    background-color: #d1ecf1;
    color: #0c5460;
    border: 1px solid #bee5eb;
}
.iob-status-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.iob-tree {
    list-style: none;
    padding-left: 0;
    margin: 0;
    font-family: monospace;
    font-size: 13px;
}
.iob-tree ul {
    list-style: none;
    padding-left: 20px;
    margin: 0;
    display: none;
}
.iob-tree li {
    cursor: pointer;
    padding: 3px 5px;
    white-space: nowrap;
    border-radius: 3px;
    transition: background-color 0.2s ease;
    user-select: none;
}
.iob-tree li:hover {
    background-color: #e8f4f8;
}
.iob-tree li.selected {
    background-color: #d4edda;
    border-left: 3px solid #28a745;
}
.iob-tree li.open > ul {
    display: block;
}
.iob-tree-icon {
    display: inline-block;
    width: 18px;
    text-align: center;
    margin-right: 5px;
    font-size: 14px;
}
.folder > .iob-tree-icon::before {
    content: 'ðŸ“';
}
.folder.open > .iob-tree-icon::before {
    content: 'ðŸ“‚';
}
.leaf > .iob-tree-icon::before {
    content: 'ðŸ”—';
    font-size: 12px;
}
.iob-tree-label {
    vertical-align: middle;
}
.iob-tree-label mark {
    background-color: #fff3cd;
    padding: 1px 2px;
    border-radius: 2px;
}
.iob-loading, .iob-error {
    text-align: center;
    padding: 20px;
    color: #666;
}
.iob-error {
    color: #dc3545;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    border-radius: 4px;
}
.iob-error small {
    display: block;
    margin-top: 5px;
    font-style: italic;
}
.red-ui-button {
    margin-top: 5px;
    padding: 5px 12px;
}
@media (max-width: 768px) {
    .iob-tree-container {
        max-height: 250px;
    }
    .iob-tree {
        font-size: 12px;
    }
    .iob-status {
        font-size: 11px;
    }
}
</style>

<script type="text/html" data-template-name="iobin">
    <div class="form-row">
        <label for="node-input-name"><i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Node name (optional)">
    </div>
    <div class="form-row">
        <label for="node-input-state"><i class="icon-tag"></i> State ID</label>
        <input type="text" id="node-input-state" placeholder="e.g. 0_userdata.0.test" required>
    </div>
    <div class="form-row">
        <label for="node-input-outputProperty"><i class="icon-tag"></i> Output Property</label>
        <input type="text" id="node-input-outputProperty" placeholder="payload">
    </div>
    <div class="form-row">
        <label for="node-input-ackFilter"><i class="icon-tag"></i> Trigger on</label>
        <select id="node-input-ackFilter" style="width:100%">
            <option value="both">Both (ack and no-ack)</option>
            <option value="ack">Acknowledged only (ack=true)</option>
            <option value="noack">Unacknowledged only (ack=false)</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="icon-tag"></i> Server</label>
        <input type="text" id="node-input-server" required>
    </div>
</script>

<script type="text/html" data-help-name="iobin">
    <p>Subscribes to an ioBroker state via WebSocket and outputs its value when it changes.</p>
    <h3>Features</h3>
    <ul>
        <li>WebSocket-based state browser and subscription</li>
        <li>Automatic reconnection and connection status display</li>
        <li>Tree view with search and quick state selection</li>
    </ul>
    <p>Double-click a state in the tree to select it.</p>
</script>